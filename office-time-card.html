<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Office Break Form</title>
  <style>
    body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:20px; }
    #greeting { font-size:20px; margin-bottom:20px; text-align:left; }
    .button { background:#0078d4; color:#fff; padding:12px 22px; border:0; border-radius:8px; cursor:pointer; font-size:16px; }
    .button:hover { background:#005fa3; }
    .link-btn { display:inline-block; background:#eceff3; color:#0f172a; padding:10px 16px; border-radius:8px; text-decoration:none; border:1px solid #d1d5db; }
    .link-btn:hover { background:#e5e7eb; }
    label { display:block; margin-top:16px; font-weight:600; text-align:left; }
    input[type="file"] { font-size:16px; margin-top:8px; width:100%; }
    textarea { width:100%; resize:vertical; min-height:100px; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ddd; margin-top:8px; }
    #status { margin-top:12px; font-size:16px; }
    .card { background:#fff; max-width:460px; margin:0 auto; padding:20px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:left; }
    .subtle { color:#555; font-size:13px; margin:6px 0 0 0; display:block; }
    .field { margin-top:18px; }
    .actions { text-align:center; margin-top:22px; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <div class="card">
    <h1 style="text-align:center;margin-top:0;">Office Time Card</h1>
    <p class="subtle" style="text-align:center;">
      Please upload your Time Card PDF and the required Meal Time Break Form.
    </p>

<!-- Open Meal Break PDF -->
<div class="actions" style="margin-bottom:8px;">
  <a class="link-btn" href="forms/meal-break.pdf" target="_blank" rel="noopener">
    Open Meal Time Break Form (PDF)
  </a>
</div>


    <!-- Required: Time Card -->
    <div class="field">
      <label for="pdfFile">Office Time Card (Required):</label>
      <input type="file" id="pdfFile" accept="application/pdf" required />
    </div>

    <!-- REQUIRED: Meal Time Break Form -->
    <div class="field">
      <label for="mealFile">Meal Time Break Form (Required):</label>
      <input type="file" id="mealFile" accept="application/pdf,image/*" required />
    </div>

    <!-- Optional: Supporting Document -->
    <div class="field">
      <label for="supportFile">Supporting Document (Optional):</label>
      <span class="subtle">Doctor's Note etc…</span>
      <input type="file" id="supportFile" accept="application/pdf,image/*" />
    </div>

    <!-- Explanations -->
    <div class="field">
      <label for="explain">Explanations (Optional):</label>
      <textarea id="explain" placeholder="Provide any additional context here…"></textarea>
    </div>

    <div class="actions">
      <button class="button" id="submitBtn">Submit Form</button>
    </div>
    <p id="status"></p>
  </div>

  <script>
    // Require techName from prior login page
    const techName = localStorage.getItem("techName");
    const techEmail = localStorage.getItem("techEmail");
    if (!techName) {
      window.location.href = "login.html";
      throw new Error("No techName in localStorage");
    }
    document.getElementById("greeting").textContent = `Hello, ${techName}!`;

    // Helper: read a File as base64 (no data: prefix) + extension
    function readFileBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          const base64 = String(dataUrl).split(",")[1] || "";
          const ext = (file.name.split(".").pop() || "").toLowerCase();
          resolve({ base64, ext });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    async function readIfChosen(inputEl) {
      const f = inputEl.files && inputEl.files[0];
      if (!f) return null;
      return await readFileBase64(f);
    }

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.addEventListener("click", async () => {
      const status = document.getElementById("status");
      const timecardEl = document.getElementById("pdfFile");
      const mealEl = document.getElementById("mealFile");
      const supportEl = document.getElementById("supportFile");
      const explainEl = document.getElementById("explain");

      const timecard = timecardEl.files[0];
      const meal = mealEl.files[0];

      // Front-end validation (Meal REQUIRED)
      if (!timecard) {
        status.textContent = "❌ Please choose a Time Card PDF.";
        status.style.color = "red";
        return;
      }
      if (!meal) {
        status.textContent = "❌ Meal Time Break Form is required.";
        status.style.color = "red";
        return;
      }

      try {
        submitBtn.disabled = true;
        status.textContent = "Uploading…";
        status.style.color = "#333";

        const { base64: timecardBase64, ext: timecardExt } = await readFileBase64(timecard);
        const mealObj = await readFileBase64(meal);
        const support = await readIfChosen(supportEl); // may be null

        const payload = {
          techName,
          techEmail,

          // Required Time Card
          pdfFile: timecardBase64,
          pdfExt: timecardExt,

          // REQUIRED Meal (now guaranteed to exist)
          mealFile: mealObj.base64,
          mealExt: mealObj.ext,

          // Optional Supporting
          supportFile: support ? support.base64 : null,
          supportExt: support ? support.ext : null,

          // Notes
          explanations: (explainEl.value || "").trim()
        };

        const resp = await fetch("https://default3afc8fb9498b4895ac67ceb1617a23.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4d8de4e65cab475ab65e755e74de4bfb/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=P1M_vIjzQjcdO42kuzfd_qwfQf5GtE8Sf49dxhzk-AY", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await resp.text();
        if (resp.ok) {
          status.textContent = "✅ Submitted successfully!";
          status.style.color = "green";
          timecardEl.value = "";
          mealEl.value = "";
          supportEl.value = "";
          explainEl.value = "";
          console.log("Flow response:", text);
        } else {
          status.textContent = `❌ ${resp.status}: ${text}`;
          status.style.color = "red";
          console.error("Flow error:", text);
        }
      } catch (err) {
        status.textContent = `❌ ${err.message}`;
        status.style.color = "red";
        console.error(err);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
