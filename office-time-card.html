<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Office Break Form</title>
  <style>
    body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:20px; }
    #greeting { font-size:20px; margin-bottom:20px; text-align:left; }
    .button { background:#0078d4; color:#fff; padding:12px 22px; border:0; border-radius:8px; cursor:pointer; font-size:16px; }
    .button:hover { background:#005fa3; }
    label { display:block; margin-top:16px; font-weight:600; text-align:left; }
    input[type="file"] { font-size:16px; margin-top:8px; width:100%; }
    textarea { width:100%; resize:vertical; min-height:100px; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ddd; margin-top:8px; }
    #status { margin-top:12px; font-size:16px; }
    .card { background:#fff; max-width:460px; margin:0 auto; padding:20px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:left; }
    .subtle { color:#555; font-size:13px; margin:6px 0 0 0; display:block; }
    .field { margin-top:18px; }
    .note { font-size:14px; color:#333; margin-top:8px; }
    .actions { text-align:center; margin-top:22px; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <div class="card">
    <h1 style="text-align:center;margin-top:0;">Office Time Card</h1>
    <p class="note">Please upload your Time Card PDF and any supporting files.</p>

    <!-- Required -->
    <div class="field">
      <label for="pdfFile">Office Time Card (Required):</label>
      <input type="file" id="pdfFile" accept="application/pdf" required />
    </div>

    <!-- Optional: Meal Time Break Form -->
    <div class="field">
      <label for="mealFile">Meal Time Break Form (Optional):</label>
      <input type="file" id="mealFile" accept="application/pdf,image/*" />
    </div>

    <!-- Optional: Supporting Document -->
    <div class="field">
      <label for="supportFile">Supporting Document (Optional):</label>
      <span class="subtle">Doctor's Note etc…</span>
      <input type="file" id="supportFile" accept="application/pdf,image/*" />
    </div>

    <!-- Explanations -->
    <div class="field">
      <label for="explain">Explanations (Optional):</label>
      <textarea id="explain" placeholder="Provide any additional context here…"></textarea>
    </div>

    <div class="actions">
      <button class="button" id="submitBtn">Submit Form</button>
    </div>
    <p id="status"></p>
  </div>

  <script>
    // Require techName from prior login page
    const techName = localStorage.getItem("techName");
    const techEmail = localStorage.getItem("techEmail");
    if (!techName) {
      window.location.href = "login.html";
      throw new Error("No techName in localStorage");
    }
    document.getElementById("greeting").textContent = `Hello, ${techName}!`;

    // Helper: read a File as base64 (no data: prefix) + extension
    function readFileBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result; // e.g. data:application/pdf;base64,AAAA...
          const base64 = String(dataUrl).split(",")[1] || "";
          const ext = (file.name.split(".").pop() || "").toLowerCase();
          resolve({ base64, ext });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Helper: read if a file was chosen; otherwise return null
    async function readIfChosen(inputEl) {
      const f = inputEl.files && inputEl.files[0];
      if (!f) return null;
      return await readFileBase64(f);
    }

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const status = document.getElementById("status");
      const fileInput = document.getElementById("pdfFile");
      const mealInput = document.getElementById("mealFile");
      const supportInput = document.getElementById("supportFile");
      const explainEl = document.getElementById("explain");

      const pdf = fileInput.files[0];

      if (!pdf) {
        status.textContent = "❌ Please choose a PDF file for the Office Time Card.";
        status.style.color = "red";
        return;
      }

      try {
        status.textContent = "Uploading…";
        status.style.color = "#333";

        // Required file
        const { base64: timecardBase64, ext: timecardExt } = await readFileBase64(pdf);

        // Optional files
        const meal = await readIfChosen(mealInput);      // {base64, ext} | null
        const support = await readIfChosen(supportInput);// {base64, ext} | null

        const payload = {
          techName,
          techEmail,

          // Required
          pdfFile: timecardBase64,
          pdfExt: timecardExt,

          // Optional: Meal Time Break Form
          mealFile: meal ? meal.base64 : null,
          mealExt: meal ? meal.ext : null,

          // Optional: Supporting Document
          supportFile: support ? support.base64 : null,
          supportExt: support ? support.ext : null,

          // Explanations
          explanations: (explainEl.value || "").trim()
        };

        const resp = await fetch("https://default3afc8fb9498b4895ac67ceb1617a23.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4d8de4e65cab475ab65e755e74de4bfb/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=P1M_vIjzQjcdO42kuzfd_qwfQf5GtE8Sf49dxhzk-AY", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const text = await resp.text();
        if (resp.ok) {
          status.textContent = "✅ Submitted successfully!";
          status.style.color = "green";
          // reset inputs
          fileInput.value = "";
          mealInput.value = "";
          supportInput.value = "";
          explainEl.value = "";
          console.log("Flow response:", text);
        } else {
          status.textContent = `❌ ${resp.status}: ${text}`;
          status.style.color = "red";
          console.error("Flow error:", text);
        }
      } catch (err) {
        status.textContent = `❌ ${err.message}`;
        status.style.color = "red";
        console.error(err);
      }
    });
  </script>
</body>
</html>
