<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Install Invoice</title>
  <style>
    body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:20px; }
    #greeting { font-size:20px; margin-bottom:20px; text-align:left; }
    .button { background:#0078d4; color:#fff; padding:12px 22px; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .button:hover { background:#005fa3; }
    label { display:block; margin-top:14px; font-weight:600; text-align:left; }
    input[type="file"] { 
      font-size:16px; padding:10px; margin-top:6px; width:100%; max-width:520px; 
      border:1px solid #ccc; border-radius:8px; 
    }
    .card { background:#fff; max-width:560px; margin:0 auto; padding:22px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:left; }
    .actions { margin-top:18px; text-align:center; }
    #status { margin-top:12px; font-size:16px; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <p style="margin-bottom:16px; text-align:center;">
    <a class="button" href="forms/install-invoice.pdf" target="_blank">Open Fillable Form</a>
  </p>

  <div class="card">
    <h1 style="margin-top:0; text-align:center;">Install Invoice</h1>
    <p style="text-align:center;">After completing the Install Invoice PDF, save it and upload it below:</p>

    <label for="pdfFile">Install Invoice PDF (Required)</label>
    <input type="file" id="pdfFile" accept="application/pdf" required />

    <label for="unitPhoto">Input Whole Unit Photo (Required)</label>
    <input type="file" id="unitPhoto" accept="image/jpeg,image/png" required />

    <label for="dataPlate">Input Data Plate (Required)</label>
    <input type="file" id="dataPlate" accept="image/jpeg,image/png" required />

    <label for="miscFile">Miscellaneous (Optional)</label>
    <input type="file" id="miscFile" accept="application/pdf,image/jpeg,image/png" />

    <div class="actions">
      <button class="button" id="submitBtn">Submit Form</button>
    </div>
    <p id="status"></p>
  </div>

<script>
  const FORM_NAME = "Install Invoice";
  const techName  = localStorage.getItem("techName");
  const techEmail = localStorage.getItem("techEmail");
  const techPhone = localStorage.getItem("techPhone");

  if (!techName || !techEmail || !techPhone) {
    window.location.href = "login.html";
    throw new Error("Technician not logged in");
  }

  document.getElementById("greeting").textContent = `Hello, ${techName}!`;

  const toBase64 = file => new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result).split(",")[1] || "");
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const status   = document.getElementById("status");
    const pdfFile  = document.getElementById("pdfFile").files[0];
    const unitFile = document.getElementById("unitPhoto").files[0];
    const plateFile= document.getElementById("dataPlate").files[0];
    const miscFile = document.getElementById("miscFile").files[0];

    if (!pdfFile || !unitFile || !plateFile) {
      status.textContent = "❌ All required files must be selected.";
      status.style.color = "red";
      return;
    }

    status.textContent = "Uploading…";
    status.style.color = "#333";
    document.getElementById("submitBtn").disabled = true;

    try {
      const [pdfB64, unitB64, plateB64, miscB64] = await Promise.all([
        toBase64(pdfFile),
        toBase64(unitFile),
        toBase64(plateFile),
        miscFile ? toBase64(miscFile) : Promise.resolve(null)
      ]);

      const payload = {
        formName: FORM_NAME,
        techName,
        techEmail,
        techPhone,
        fileContent: pdfB64,
        unitPhoto:   unitB64,
        dataPlate:   plateB64,
        miscFile:    miscB64,
        fileContentName: pdfFile.name,
        unitPhotoName:   unitFile.name,
        dataPlateName:   plateFile.name,
        miscFileName:    miscFile ? miscFile.name : null
      };

      const flowUrl = "https://default3afc8fb9498b4895ac67ceb1617a23.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/eacc8ddf9c914016a1a6c02f8003d618/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=u1sXRVYWjVQioTas_fnaSpwZzdZWGohIc3lEG1ru3UI";
      const resp = await fetch(flowUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json;charset=UTF-8" },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      if (resp.ok) {
        status.textContent = "✅ Form submitted successfully!";
        status.style.color = "green";
        document.querySelectorAll('input[type="file"]').forEach(i => i.value = "");
      } else {
        status.textContent = `❌ ${resp.status}: ${text}`;
        status.style.color = "red";
        console.error("Flow response:", text);
      }
    } catch (err) {
      status.textContent = `❌ ${err.message}`;
      status.style.color = "red";
      console.error(err);
    } finally {
      document.getElementById("submitBtn").disabled = false;
    }
  });
</script>
</body>
</html>
