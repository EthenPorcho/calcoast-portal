<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Repair Form</title>
  <style>
    body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:20px; }
    #greeting { font-size:20px; margin-bottom:20px; text-align:left; }
    .button { background:#0078d4; color:#fff; padding:12px 22px; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .button:hover { background:#005fa3; }
    label { display:block; margin-top:14px; font-weight:600; text-align:left; }
    input[type="file"] {
      font-size:16px; padding:10px; margin-top:6px; width:100%; max-width:520px;
      border:1px solid #ccc; border-radius:8px;
    }
    .card { background:#fff; max-width:560px; margin:0 auto; padding:22px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:left; }
    .actions { margin-top:18px; text-align:center; }
    #status { margin-top:12px; font-size:16px; }
    .hint { font-size:12px; color:#666; margin-top:4px; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <p style="margin-bottom:16px; text-align:center;">
    <a class="button" href="forms/service-repair-sheet.pdf" target="_blank">Open Fillable Form</a>
  </p>

  <div class="card">
    <h1 style="margin-top:0; text-align:center;">Service Repair Form</h1>
    <p style="text-align:center;">After completing the repair PDF, save it and upload it below:</p>

    <label for="pdfFile">Service Repair PDF (Required)</label>
    <input type="file" id="pdfFile" accept="application/pdf" required />

    <label for="unitPhoto">Input Whole Unit Photo (Required)</label>
    <input type="file" id="unitPhoto" accept="image/jpeg,image/png" required />

    <label for="dataPlate">Input Data Plate (Required)</label>
    <input type="file" id="dataPlate" accept="image/jpeg,image/png" required />

    <label for="miscFile">Miscellaneous (Optional)</label>
    <input
      type="file"
      id="miscFile"
      accept="application/pdf,image/jpeg,image/png,video/mp4,video/webm,video/quicktime"
      multiple
    />
    <div class="hint">You can select multiple files (PDFs, images, or videos). Hold Ctrl/Cmd while clicking to select more than one.</div>

    <div class="actions">
      <button class="button" id="submitBtn">Submit Form</button>
    </div>
    <p id="status"></p>
  </div>

<script>
  const techName  = localStorage.getItem("techName");
  const techEmail = localStorage.getItem("techEmail");
  const techPhone = localStorage.getItem("techPhone");

  if (!techName || !techEmail || !techPhone) {
    window.location.href = "login.html";
    throw new Error("Technician not logged in");
  }

  document.getElementById("greeting").textContent = `Hello, ${techName}!`;

  const toBase64 = file => new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => {
      const result = String(r.result);
      const comma = result.indexOf(",");
      resolve(comma >= 0 ? result.slice(comma + 1) : result);
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const statusEl = document.getElementById("status");
    const pdfFile   = document.getElementById("pdfFile").files[0];
    const unitPhoto = document.getElementById("unitPhoto").files[0];
    const dataPlate = document.getElementById("dataPlate").files[0];
    const miscList  = document.getElementById("miscFile").files; // FileList (0..N)

    if (!pdfFile || !unitPhoto || !dataPlate) {
      statusEl.textContent = "❌ All required files must be selected.";
      statusEl.style.color = "red";
      return;
    }

    statusEl.textContent = "Uploading…";
    statusEl.style.color = "#333";
    document.getElementById("submitBtn").disabled = true;

    try {
      // Base64 for requireds
      const [pdfB64, unitB64, plateB64] = await Promise.all([
        toBase64(pdfFile),
        toBase64(unitPhoto),
        toBase64(dataPlate)
      ]);

      // Base64 for unlimited misc files
      const miscFilesArray = [];
      for (let i = 0; i < miscList.length; i++) {
        const f = miscList[i];
        const contentB64 = await toBase64(f);
        miscFilesArray.push({
          name: f.name,
          contentType: f.type || "",
          contentBase64: contentB64
        });
      }

      // Back-compat simple arrays if your Flow currently expects these:
      const miscB64Array  = miscFilesArray.map(x => x.contentBase64);
      const miscNameArray = miscFilesArray.map(x => x.name);

      const payload = {
        techName,
        techEmail,
        techPhone,

        // requireds
        fileContent: pdfB64,
        unitPhoto:   unitB64,
        dataPlate:   plateB64,
        fileContentName: pdfFile.name,
        unitPhotoName:   unitPhoto.name,
        dataPlateName:   dataPlate.name,

        // new structured misc array
        miscFiles: miscFilesArray,

        // (optional) legacy arrays for existing flows
        miscFileNames: miscNameArray,
        miscFileContents: miscB64Array
      };

      const flowUrl = "https://default3afc8fb9498b4895ac67ceb1617a23.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/eacc8ddf9c914016a1a6c02f8003d618/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=u1sXRVYWjVQioTas_fnaSpwZzdZWGohIc3lEG1ru3UI";

      const resp = await fetch(flowUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json;charset=UTF-8" },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      if (resp.ok) {
        const miscCount = miscFilesArray.length;
        statusEl.textContent = `✅ Form submitted successfully! (${miscCount} misc file${miscCount===1?"":"s"} included)`;
        statusEl.style.color = "green";
        document.querySelectorAll('input[type="file"]').forEach(i => i.value = "");
      } else {
        statusEl.textContent = `❌ ${resp.status}: ${text}`;
        statusEl.style.color = "red";
        console.error("Flow response:", text);
      }
    } catch (err) {
      statusEl.textContent = `❌ ${err.message}`;
      statusEl.style.color = "red";
      console.error(err);
    } finally {
      document.getElementById("submitBtn").disabled = false;
    }
  });
</script>
</body>
</html>
