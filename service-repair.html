<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Repair Form</title>
  <style>
    body { font-family: sans-serif; background:#f0f0f0; text-align:center; padding:20px; }
    #greeting { font-size:20px; margin-bottom:20px; text-align:left; }
    .button { background:#0078d4; color:#fff; padding:12px 22px; border:0; border-radius:8px; font-size:16px; cursor:pointer; }
    .button:hover { background:#005fa3; }
    label { display:block; margin-top:14px; font-weight:600; text-align:left; }
    input[type="file"] {
      font-size:16px; padding:10px; margin-top:6px; width:100%; max-width:520px;
      border:1px solid #ccc; border-radius:8px;
    }
    .card { background:#fff; max-width:560px; margin:0 auto; padding:22px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); text-align:left; }
    .actions { margin-top:18px; text-align:center; }
    #status { margin-top:12px; font-size:16px; }
    .hint { font-size:12px; color:#666; margin-top:4px; }
    .misc-row { display:flex; align-items:center; gap:8px; margin-top:10px; }
    .misc-row label { margin:0; min-width:120px; }
    .link { background:none; border:0; color:#c1121f; cursor:pointer; font-weight:600; }
    .muted { color:#666; font-size:12px; margin-top:6px; }
  </style>
</head>
<body>
  <div id="greeting"></div>

  <p style="margin-bottom:16px; text-align:center;">
    <a class="button" href="forms/service-repair-sheet.pdf" target="_blank">Open Fillable Form</a>
  </p>

  <div class="card">
    <h1 style="margin-top:0; text-align:center;">Service Repair Form</h1>
    <p style="text-align:center;">After completing the repair PDF, save it and upload it below:</p>

    <label for="pdfFile">Service Repair PDF (Required)</label>
    <input type="file" id="pdfFile" accept="application/pdf" required />

    <label for="unitPhoto">Input Whole Unit Photo (Required)</label>
    <input type="file" id="unitPhoto" accept="image/jpeg,image/png" required />

    <label for="dataPlate">Input Data Plate (Required)</label>
    <input type="file" id="dataPlate" accept="image/jpeg,image/png" required />

    <div style="margin-top:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Misc Photos (Optional)</h3>
        <button class="button" id="addMiscBtn" type="button">Add another photo</button>
      </div>
      <div class="muted" id="miscCounter">0 / 20</div>
      <div id="miscContainer"></div>
      <div class="hint">Add up to 20 separate photo slots. Each slot accepts one image (JPG/PNG).</div>
    </div>

    <div class="actions">
      <button class="button" id="submitBtn">Submit Form</button>
    </div>
    <p id="status"></p>
  </div>

<script>
  // --- login guard ---
  const techName  = localStorage.getItem("techName");
  const techEmail = localStorage.getItem("techEmail");
  const techPhone = localStorage.getItem("techPhone");
  if (!techName || !techEmail || !techPhone) {
    window.location.href = "login.html";
    throw new Error("Technician not logged in");
  }
  document.getElementById("greeting").textContent = `Hello, ${techName}!`;

  // --- misc slots UI (array-based) ---
  const MAX_MISC = 20;
  const miscContainer = document.getElementById("miscContainer");
  const addMiscBtn = document.getElementById("addMiscBtn");
  const miscCounter = document.getElementById("miscCounter");

  const updateMiscCounter = () => {
    const count = miscContainer.querySelectorAll(".misc-row").length;
    miscCounter.textContent = `${count} / ${MAX_MISC}`;
    addMiscBtn.disabled = count >= MAX_MISC;
  };

  const addMiscInput = () => {
    const idx = miscContainer.querySelectorAll(".misc-row").length + 1;
    if (idx > MAX_MISC) return;

    const row = document.createElement("div");
    row.className = "misc-row";

    const label = document.createElement("label");
    label.textContent = `Photo ${idx}`;
    label.setAttribute("for", `miscFile_${idx}`);

    const input = document.createElement("input");
    input.type = "file";
    input.id = `miscFile_${idx}`;
    input.name = `miscFile_${idx}`;
    input.accept = "image/jpeg,image/png";

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "link";
    removeBtn.textContent = "Remove";
    removeBtn.addEventListener("click", () => {
      row.remove();
      // re-number so Photo N matches field order
      [...miscContainer.querySelectorAll(".misc-row")].forEach((r, i) => {
        const lab = r.querySelector("label");
        const inp = r.querySelector('input[type="file"]');
        lab.textContent = `Photo ${i + 1}`;
        lab.setAttribute("for", `miscFile_${i + 1}`);
        inp.id = `miscFile_${i + 1}`;
        inp.name = `miscFile_${i + 1}`;
      });
      updateMiscCounter();
    });

    row.appendChild(label);
    row.appendChild(input);
    row.appendChild(removeBtn);
    miscContainer.appendChild(row);
    updateMiscCounter();
  };

  addMiscBtn.addEventListener("click", addMiscInput);
  updateMiscCounter();

  // --- helpers ---
  const toBase64 = file => new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => {
      const s = String(r.result);
      const i = s.indexOf(",");
      resolve(i >= 0 ? s.slice(i + 1) : s);
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  // --- submit ---
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const statusEl = document.getElementById("status");
    const pdfFile   = document.getElementById("pdfFile").files[0];
    const unitPhoto = document.getElementById("unitPhoto").files[0];
    const dataPlate = document.getElementById("dataPlate").files[0];

    if (!pdfFile || !unitPhoto || !dataPlate) {
      statusEl.textContent = "❌ All required files must be selected.";
      statusEl.style.color = "red";
      return;
    }

    statusEl.textContent = "Uploading…";
    statusEl.style.color = "#333";
    document.getElementById("submitBtn").disabled = true;
    addMiscBtn.disabled = true;

    try {
      const [pdfB64, unitB64, plateB64] = await Promise.all([
        toBase64(pdfFile),
        toBase64(unitPhoto),
        toBase64(dataPlate)
      ]);

      // Collect misc photos into ONE ARRAY → [{name, base64}]
      const miscFiles = [];
      const inputs = [...miscContainer.querySelectorAll('input[type="file"]')];
      for (const inp of inputs) {
        const f = inp.files?.[0];
        if (!f) continue;
        const b64 = await toBase64(f);
        miscFiles.push({
  name: f.name,
  contentBase64: b64,   // <-- use this key to match schema
  contentType: f.type || ""
});


      // payload with miscFiles array
      const payload = {
        techName,
        techEmail,
        techPhone,
        fileContent: pdfB64,
        fileContentName: pdfFile.name,
        unitPhoto: unitB64,
        unitPhotoName: unitPhoto.name,
        dataPlate: plateB64,
        dataPlateName: dataPlate.name,
        miscFiles
      };

      // Flow URL (HTTP Request trigger expecting 'miscFiles' array)
      const flowUrl = "https://default3afc8fb9498b4895ac67ceb1617a23.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/eacc8ddf9c914016a1a6c02f8003d618/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=u1sXRVYWjVQioTas_fnaSpwZzdZWGohIc3lEG1ru3UI";

      const resp = await fetch(flowUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json;charset=UTF-8" },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      if (resp.ok) {
        const miscCount = miscFiles.length;
        statusEl.textContent = `✅ Form submitted successfully! (${miscCount} misc photo${miscCount===1?"":"s"} included)`;
        statusEl.style.color = "green";
        // reset
        document.querySelectorAll('input[type="file"]').forEach(i => i.value = "");
        miscContainer.innerHTML = "";
        updateMiscCounter();
      } else {
        statusEl.textContent = `❌ ${resp.status}: ${text}`;
        statusEl.style.color = "red";
        console.error("Flow response:", text);
      }
    } catch (err) {
      statusEl.textContent = `❌ ${err.message}`;
      statusEl.style.color = "red";
      console.error(err);
    } finally {
      document.getElementById("submitBtn").disabled = false;
      addMiscBtn.disabled = miscContainer.querySelectorAll(".misc-row").length >= MAX_MISC;
    }
  });
</script>
</body>
</html>
