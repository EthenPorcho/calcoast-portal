<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Save a Card • Cal Coast Refrigeration</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root { --pad: 20px; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: #0b1220; color: #eef2ff;
      display: grid; place-items: center; min-height: 100dvh; padding: 20px;
    }
    .card {
      width: 100%; max-width: 520px; background: #0f172a; border: 1px solid #1f2b52;
      border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); overflow: hidden;
    }
    .hdr { padding: var(--pad); border-bottom: 1px solid #1f2b52; display:flex; justify-content:space-between; align-items:center;}
    .hdr h1 { font-size: 18px; margin: 0; letter-spacing:.2px; }
    .meta { font-size:12px; color:#9fb1ff; }
    form { padding: var(--pad); display: grid; gap: 14px; }
    #payment-element { padding: 12px; background:#0b1220; border:1px solid #1f2b52; border-radius:12px; }
    .row { display:grid; gap:8px; }
    label { font-size: 12px; color:#c7d2fe }
    input[type="email"], input[type="text"] {
      background:#0b1220; border:1px solid #1f2b52; color:#e5e7eb; border-radius:10px; padding:10px 12px; width:100%;
    }
    .btn {
      display: inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 12px 16px; border-radius: 12px; border:1px solid #334155;
      background: #2563eb; color: white; font-weight:600; cursor:pointer;
    }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .muted { color:#94a3b8; font-size:12px; }
    .footer { padding: var(--pad); border-top: 1px solid #1f2b52; display:flex; justify-content:space-between; align-items:center;}
    .status { padding: var(--pad); display:none; }
    .ok { color:#34d399; }
    .err { color:#fda4af; white-space: pre-wrap; }
    .hidden { display:none !important; }
    .badge { font-size: 11px; padding:3px 8px; border-radius:999px; border:1px solid #334155; color:#cbd5e1;}
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="hdr">
      <h1>Securely Save Your Card</h1>
      <div class="meta">
        <span class="badge" id="jobBadge">Job: —</span>
        <span class="badge" id="custBadge">Cust: —</span>
      </div>
    </div>

    <form id="form">
      <div class="row">
        <label for="email">Receipt email (optional)</label>
        <input id="email" name="email" type="email" autocomplete="email" placeholder="you@example.com" />
      </div>

      <div id="payment-element"></div>

      <div class="row2">
        <button id="submit" class="btn" type="submit">
          <span id="btnText">Save card</span>
          <span id="spinner" class="hidden">…</span>
        </button>
        <button id="cancelBtn" class="btn" type="button" style="background:#0b1220;border-color:#334155">
          Cancel
        </button>
      </div>

      <div class="muted">Cards are encrypted & tokenized by Stripe. We never store your full card number.</div>
    </form>

    <div id="status" class="status">
      <div id="ok" class="ok hidden">✅ Card on file. You can close this page.</div>
      <div id="err" class="err hidden"></div>
    </div>

    <div class="footer">
      <div class="muted" id="brand">Powered by Stripe</div>
      <a class="muted" href="#" id="closeLink">Close</a>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const clientSecret = qs.get('client_secret'); // REQUIRED
      const pk = qs.get('pk') || 'pk_live_xxx_replace_me'; // publishable key (can pass via URL)
      const jobId = qs.get('job_id') || '—';
      const customerId = qs.get('cust_id') || '—';
      const confirmUrl = qs.get('confirm_url'); // optional: POST here after success for instant UI
      const returnUrl = qs.get('return_url'); // optional: if you want to bounce back to PA/portal

      // Update badges
      document.getElementById('jobBadge').textContent = `Job: ${jobId}`;
      document.getElementById('custBadge').textContent = `Cust: ${customerId}`;

      if (!clientSecret) {
        showError("Missing client_secret in URL.");
        return;
      }

      const stripe = Stripe(pk);
      const elements = stripe.elements({ clientSecret });

      const paymentElement = elements.create('payment', {
        fields: { billingDetails: { email: 'auto' } }
      });
      paymentElement.mount('#payment-element');

      const form = document.getElementById('form');
      const submitBtn = document.getElementById('submit');
      const btnText = document.getElementById('btnText');
      const spinner = document.getElementById('spinner');
      const closeLink = document.getElementById('closeLink');
      const cancelBtn = document.getElementById('cancelBtn');

      closeLink.addEventListener('click', (e) => { e.preventDefault(); tryClose(); });
      cancelBtn.addEventListener('click', tryClose);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);

        const email = document.getElementById('email').value || undefined;

        // Confirm the SetupIntent. Redirect only if required (3DS).
        const { setupIntent, error } = await stripe.confirmSetup({
          elements,
          clientSecret,
          confirmParams: {
            receipt_email: email,
            // If you want a hard redirect flow use return_url; otherwise 'if_required' keeps it SPA-style.
            return_url: returnUrl || undefined
          },
          redirect: 'if_required'
        });

        if (error) {
          showError(explainStripeError(error));
          setLoading(false);
          return;
        }

        // Handle final state
        if (setupIntent && setupIntent.status === 'succeeded') {
          await maybeNotify(confirmUrl, {
            JobID: jobId,
            CustomerID: customerId,
            SetupIntentId: setupIntent.id,
            PaymentMethodId: setupIntent.payment_method,
            ClientSecret: clientSecret
          });
          showSuccess();
          setLoading(false);
          return;
        }

        // Other non-failed terminal states
        showError(`Unexpected status: ${setupIntent?.status || 'unknown'}`);
        setLoading(false);
      });

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        spinner.classList.toggle('hidden', !isLoading);
        btnText.textContent = isLoading ? 'Saving…' : 'Save card';
      }

      function showSuccess() {
        document.getElementById('status').style.display = 'block';
        document.getElementById('ok').classList.remove('hidden');
        document.getElementById('err').classList.add('hidden');
        // Attempt to notify opener (Power Apps web view) that we're done
        try { window.opener && window.opener.postMessage({ type:'CCR_CARD_SAVED', jobId, customerId }, '*'); } catch {}
      }

      function showError(msg) {
        document.getElementById('status').style.display = 'block';
        const err = document.getElementById('err');
        err.textContent = msg || 'Something went wrong.';
        err.classList.remove('hidden');
        document.getElementById('ok').classList.add('hidden');
      }

      async function maybeNotify(url, payload) {
        if (!url) return;
        try {
          await fetch(url, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          // Non-blocking; webhooks remain source of truth
          console.warn('notify failed', e);
        }
      }

      function explainStripeError(error) {
        if (!error) return 'Unknown error.';
        if (error.message) return error.message;
        if (error.type) return `Stripe error: ${error.type}`;
        return 'Payment confirmation failed.';
      }

      function tryClose() {
        try { window.close(); } catch {}
        // iOS Safari fallback: navigate away
        location.href = returnUrl || 'about:blank';
      }
    })();
  </script>
</body>
</html>

